<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wheelchair Maintenance Reminder</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="https://favicon.io/favicon.ico">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Wheelchair Reminder">
</head>
<body>
  <button class="admin-login" onclick="adminLogin()">Admin Login</button>
  <div class="container">
    <h1>Wheelchair Maintenance Reminder</h1>
    <div id="selection-card" class="card">
      <h2>Select Your Equipment</h2>
      <div class="selection-container">
        <table>
          <tr><th colspan="2" class="label">Primary Equipment (Optional)</th></tr>
          <tr><td colspan="2"><select id="primary-equipment" class="select"><option value="">Select one</option><option value="Rigid Ultra-Light Manual Wheelchair">Rigid Ultra-Light Manual Wheelchair</option><option value="Folding Ultra-Light Manual Wheelchair">Folding Ultra-Light Manual Wheelchair</option><option value="Power Wheelchair with Power Seating Functions">Power Wheelchair with Power Seating Functions</option><option value="Power Wheelchair without Power Seating Functions">Power Wheelchair without Power Seating Functions</option><option value="Tilt in Space Manual Wheelchair">Tilt in Space Manual Wheelchair</option></select></td></tr>
          <tr><th colspan="2" class="label">Optional Power Assist (Select one or both)</th></tr>
          <tr><td><label><input type="checkbox" id="detachable-power-assist" value="Detachable Power Assist"> Detachable Power Assist</label></td><td><label><input type="checkbox" id="hand-rim-power-assist" value="Hand-Rim Activated Power Assist"> Hand-Rim Activated Power Assist</label></td></tr>
          <tr><th colspan="2" class="label">Seat Cushions (One or more)</th></tr>
          <tr><td><label><input type="checkbox" id="air-seat" value="Air Seat Cushion"> Air Seat Cushion</label></td><td><label><input type="checkbox" id="foam-seat" value="Foam Seat Cushion"> Foam Seat Cushion</label></td></tr>
          <tr><td><label><input type="checkbox" id="gel-seat" value="Gel Seat Cushion"> Gel Seat Cushion</label></td><td></td></tr>
          <tr><th colspan="2" class="label">Backrest Cushions (One or more)</th></tr>
          <tr><td><label><input type="checkbox" id="air-backrest" value="Air Backrest Cushion"> Air Backrest Cushion</label></td><td><label><input type="checkbox" id="foam-backrest" value="Foam Backrest Cushion"> Foam Backrest Cushion</label></td></tr>
          <tr><td><label><input type="checkbox" id="gel-backrest" value="Gel Backrest Cushion"> Gel Backrest Cushion</label></td><td></td></tr>
        </table>
      </div>
      <div class="nav-buttons">
        <button id="home-button" class="button">Home</button>
        <button id="next-to-contact" class="button">Next: Enter Contact Info</button>
      </div>
      <div class="since-date" id="since-date"></div>
    </div>
    <div id="contact-card" class="card hidden">
      <h2>Contact Information</h2>
      <form id="contact-form">
        <div class="label">Wheelchair Vendor</div>
        <input type="text" id="vendor-company" placeholder="Company Name" required>
        <input type="text" id="vendor-rep" placeholder="Representative Name" required>
        <input type="tel" id="vendor-phone" placeholder="Phone Number" required>
        <input type="email" id="vendor-email" placeholder="Email" required>
        <div class="label">Clinical Therapist</div>
        <input type="text" id="therapist-hospital" placeholder="Hospital/Clinic Name" required>
        <input type="text" id="therapist-name" placeholder="Therapist Name" required>
        <input type="tel" id="therapist-phone" placeholder="Phone Number" required>
        <input type="email" id="therapist-email" placeholder="Email" required>
      </form>
      <div class="nav-buttons">
        <button id="home-button" class="button">Home</button>
        <button id="submit-contact" class="button">Submit</button>
      </div>
      <div class="since-date" id="since-date"></div>
    </div>
    <div id="reminders-card" class="card hidden">
      <h2>My Equipment & Reminders</h2>
      <ul id="equipment-list"></ul>
      <div class="nav-buttons">
        <button id="home-button" class="button">Home</button>
        <button id="submit-reminders" class="button">Finish</button>
      </div>
      <div class="since-date" id="since-date"></div>
    </div>
    <div id="profile-card" class="card hidden">
      <h2>My Mobility Equipment</h2>
      <ul id="profile-list"></ul>
      <div class="profile-link" onclick="editContacts()">Edit Contact Information</div>
      <div class="profile-link" onclick="editProfile()">Edit My Equipment</div>
      <div class="nav-buttons">
        <!-- Removed "Home" button from profile -->
      </div>
      <button id="turn-on-reminders-profile" class="turn-on-button">Turn On Reminders</button>
      <button id="reset-data-profile" class="reset-button">Reset/Erase Data</button>
      <button id="faq-button" class="faq-button" onclick="window.open('https://drive.google.com/drive/folders/1r39RgaP2TBT8q-FUE5YirebYoezFSqV7', '_blank')">FAQ/Resource Guide</button>
      <div class="instructions" id="calendar-instructions">
        <h3>How to Add Your Reminder Schedule</h3>
        <p>1. Click the "Download Reminder Schedule" button below to download your custom calendar file, or the download will automatically begin once you select the “Turn On Reminders” button.</p>
        <p>2. Open your calendar app (e.g., Google Calendar, Apple Calendar).</p>
        <p>3. Import the downloaded .ics file (look for "Import" or "Add Calendar" in the app settings; instructions may differ depending on your browser).</p>
        <p>4. Set your preferred reminder time (e.g., 1 day before) in the calendar app if needed; default alerts are set for 9:00 AM in your local time zone.</p>
        <p><strong>Note:</strong> This schedule covers maintenance reminders for your selected equipment over the next 1 year, spaced according to weekly, monthly, 3-month, 6-month, and yearly intervals starting from the download date.</p>
        <button id="download-ics" class="button" style="margin-top: 1rem;">Download Reminder Schedule</button>
      </div>
      <div class="disclaimer">
        <em>*Developed by Blake Perkins PT, DPT, ATP at the MetroHealth System Physical Medicine & Rehabilitation Department, supported by Craig H. Neilsen Allied Health Research Award of ASIA. This app supports end-user autonomy with wheelchair and seating system maintenance but is not intended to replace user manuals. For questions or concerns, contact bperkins@metrohealth.org.*</em>
      </div>
      <div class="since-date" id="since-date"></div>
    </div>
    <div id="admin-data" class="card hidden">
      <h2>Admin Statistics</h2>
      <p>Mobility Base: <span id="mobility-base-count"></span></p>
      <p>Backrest Cushion: <span id="backrest-count"></span></p>
      <p>Seat Cushion: <span id="seat-count"></span></p>
      <p>Total Users: <span id="user-count">0</span></p>
      <p>Users with Reminders: <span id="reminder-count">0</span></p>
      <p>Users with Reminders Disabled: <span id="disable-count">0</span></p>
    </div>
    <div id="error" class="error" style="display: none;"></div>
  </div>
  <script>
    const MAINTENANCE_SCHEDULES = {
      "Rigid Ultra-Light Manual Wheelchair": { 
        label: "Rigid Ultra-Light Manual Wheelchair",
        tasks: [
          { task: "Ensure wheelchair rolls straight without excessive drag or pull", redFlag: "Contact vendor if issues persist", interval: "1W" },
          { task: "Inspect for loose, missing, broken, worn, or damaged hardware", redFlag: "Contact vendor if hardware is compromised", interval: "1W" },
          { task: "Inspect wheels for cracked, bent, or broken spokes", redFlag: "Contact vendor if spokes are damaged", interval: "1W" },
          { task: "Ensure all spokes are uniformly tight", redFlag: "Contact vendor if uneven", interval: "3M" },
          { task: "Inspect hubs and rims for cracks and wear", redFlag: "Contact vendor if damaged", interval: "3M" },
          { task: "Inspect for 'trueness' (excessive side movement when wheel lifted and spun)", redFlag: "Contact vendor if not true", interval: "3M" },
          { task: "Ensure axles are free of dirt and lint; wipe with dry silicone or Teflon-based lubricant", redFlag: "Contact vendor if axles are worn", interval: "1W" },
          { task: "Check rear tires for proper inflation if pneumatic; inspect for cracks, wear, and flat spots", redFlag: "Contact vendor if tires are damaged", interval: "1W" },
          { task: "Ensure handrims are free of rough edges or peeling and securely attached", redFlag: "Contact vendor if handrims are loose", interval: "1W" },
          { task: "Ensure wheel locks embed properly into tire and prevent movement when engaged", redFlag: "Contact vendor if wheel locks fail", interval: "1W" },
          { task: "Inspect seat sling and back upholstery for rips or sagging", redFlag: "Contact vendor if upholstery is damaged", interval: "3M" },
          { task: "Inspect casters and forks for cracks and wear", redFlag: "Contact vendor if damaged", interval: "1W" },
          { task: "Inspect footrests and hangers to ensure all hardware is securely attached", redFlag: "Contact vendor if loose", interval: "3M" },
          { task: "Inspect frame for cracks", redFlag: "Contact vendor if cracked", interval: "3M" },
          { task: "Inspect anti-tip wheels for cracks and wear", redFlag: "Contact vendor if damaged", interval: "3M" },
          { task: "Call vendor for annual mobility base inspection and return to app to refresh reminders", redFlag: "", interval: "1Y" }
        ]
      },
      "Folding Ultra-Light Manual Wheelchair": { 
        label: "Folding Ultra-Light Manual Wheelchair",
        tasks: [
          { task: "Ensure wheelchair rolls straight without excessive drag or pull", redFlag: "Contact vendor if issues persist", interval: "1W" },
          { task: "Inspect for loose, missing, broken, worn, or damaged hardware, including hinges and crossbraces", redFlag: "Contact vendor if hardware is compromised", interval: "1W" },
          { task: "Inspect wheels for cracked, bent, or broken spokes", redFlag: "Contact vendor if spokes are damaged", interval: "1W" },
          { task: "Ensure all spokes are uniformly tight", redFlag: "Contact vendor if uneven", interval: "3M" },
          { task: "Inspect hubs and rims for cracks and wear", redFlag: "Contact vendor if damaged", interval: "3M" },
          { task: "Inspect for 'trueness' (excessive side movement when wheel lifted and spun)", redFlag: "Contact vendor if not true", interval: "3M" },
          { task: "Ensure axles are free of dirt and lint; wipe with dry silicone or Teflon-based lubricant", redFlag: "Contact vendor if axles are worn", interval: "1W" },
          { task: "Check rear tires for proper inflation if pneumatic; inspect for cracks, wear, and flat spots", redFlag: "Contact vendor if tires are damaged", interval: "1W" },
          { task: "Ensure handrims are free of rough edges or peeling and securely attached", redFlag: "Contact vendor if handrims are loose", interval: "1W" },
          { task: "Ensure wheel locks embed properly into tire and prevent movement when engaged", redFlag: "Contact vendor if wheel locks fail", interval: "1W" },
          { task: "Inspect seat sling and back upholstery for rips or sagging", redFlag: "Contact vendor if upholstery is damaged", interval: "3M" },
          { task: "Inspect casters and forks for cracks and wear", redFlag: "Contact vendor if damaged", interval: "1W" },
          { task: "Inspect footrests and hangers to ensure all hardware is securely attached", redFlag: "Contact vendor if loose", interval: "3M" },
          { task: "Inspect frame for cracks, including folding mechanisms and crossbraces", redFlag: "Contact vendor if cracked", interval: "3M" },
          { task: "Inspect anti-tip wheels for cracks and wear", redFlag: "Contact vendor if damaged", interval: "3M" },
          { task: "Call vendor for annual mobility base inspection and return to app to refresh reminders", redFlag: "", interval: "1Y" }
        ]
      },
      "Power Wheelchair with Power Seating Functions": { 
        label: "Power Wheelchair with Power Seating Functions",
        tasks: [
          { task: "Inspect positioning belts for wear and ensure buckles work", redFlag: "Contact vendor if worn", interval: "1W" },
          { task: "Check pneumatic tires for proper inflation and inflate to recommended pressure", redFlag: "Contact vendor if tire does not hold air", interval: "1W" },
          { task: "Test brakes on a level surface", redFlag: "Contact vendor if issue", interval: "1W" },
          { task: "Disconnect and inspect controller from power base for corrosion", redFlag: "Contact vendor if needed", interval: "1W" },
          { task: "Ensure all controller system parts are securely fastened without overtightening screws", redFlag: "Contact vendor if loose", interval: "1W" },
          { task: "Check connectors and cables for damage and ensure they are securely mated", redFlag: "Contact vendor if damaged", interval: "1W" },
          { task: "Visually inspect joystick gaiter for damage", redFlag: "Contact vendor if damaged", interval: "1W" },
          { task: "Ensure all control system components are securely mounted", redFlag: "Contact vendor if loose", interval: "1W" },
          { task: "Operate all electric options to ensure they work correctly", redFlag: "Contact vendor if not working", interval: "1W" },
          { task: "Drive with seating elevated to ensure ‘creep’ mode works", redFlag: "Contact vendor if fails", interval: "1W" },
          { task: "Drive in each profile to confirm performance", redFlag: "Contact vendor if in doubt", interval: "1W" },
          { task: "Check Velcro straps for correct adhesion and remove contamination", redFlag: "Contact vendor if ineffective", interval: "1W" },
          { task: "Clean wheelchair and upholstery", redFlag: "Contact vendor if cleaning reveals damage", interval: "1M" },
          { task: "Check upholstery, seating, and postural supports for wear", redFlag: "Contact vendor if worn", interval: "1M" },
          { task: "Verify freewheel mode and lever work properly", redFlag: "Contact vendor if fails", interval: "1M" },
          { task: "Check drive tire wear", redFlag: "Contact vendor for repair", interval: "1M" },
          { task: "Inspect caster wheels for wear and replace if necessary", redFlag: "Contact vendor for repair", interval: "1M" },
          { task: "Check caster forks for damage or fluttering", redFlag: "Contact vendor for repair", interval: "1M" },
          { task: "Inspect all hardware for looseness or performance changes", redFlag: "Contact vendor for service", interval: "1M" },
          { task: "Check all fasteners for wear", redFlag: "Contact vendor if worn", interval: "1M" },
          { task: "Inspect all straps for fraying or excessive wear", redFlag: "Discontinue use if damaged", interval: "1M" },
          { task: "Check tire pressure regularly and ensure drive wheels are equally inflated", redFlag: "Contact vendor if pressure issues", interval: "1M" },
          { task: "Call vendor for annual mobility base inspection and return to app to refresh reminders", redFlag: "", interval: "1Y" }
        ]
      },
      "Power Wheelchair without Power Seating Functions": { 
        label: "Power Wheelchair without Power Seating Functions",
        tasks: [
          { task: "Inspect positioning belts for wear and ensure buckles work", redFlag: "Contact vendor if worn", interval: "1W" },
          { task: "Check pneumatic tires for proper inflation and inflate to recommended pressure", redFlag: "Contact vendor if tire does not hold air", interval: "1W" },
          { task: "Test brakes on a level surface", redFlag: "Contact vendor if issue", interval: "1W" },
          { task: "Disconnect and inspect controller from power base for corrosion", redFlag: "Contact vendor if needed", interval: "1W" },
          { task: "Ensure all controller system parts are securely fastened without overtightening screws", redFlag: "Contact vendor if loose", interval: "1W" },
          { task: "Check connectors and cables for damage and ensure they are securely mated", redFlag: "Contact vendor if damaged", interval: "1W" },
          { task: "Visually inspect joystick gaiter for damage", redFlag: "Contact vendor if damaged", interval: "1W" },
          { task: "Ensure all control system components are securely mounted", redFlag: "Contact vendor if loose", interval: "1W" },
          { task: "Clean wheelchair and upholstery", redFlag: "Contact vendor if cleaning reveals damage", interval: "1M" },
          { task: "Check upholstery and postural supports for wear", redFlag: "Contact vendor if worn", interval: "1M" },
          { task: "Verify freewheel mode and lever work properly", redFlag: "Contact vendor if fails", interval: "1M" },
          { task: "Check drive tire wear", redFlag: "Contact vendor for repair", interval: "1M" },
          { task: "Inspect caster wheels for wear and replace if necessary", redFlag: "Contact vendor for repair", interval: "1M" },
          { task: "Check caster forks for damage or fluttering", redFlag: "Contact vendor for repair", interval: "1M" },
          { task: "Inspect all hardware for looseness or performance changes", redFlag: "Contact vendor for service", interval: "1M" },
          { task: "Check all fasteners for wear", redFlag: "Contact vendor if worn", interval: "1M" },
          { task: "Inspect all straps for fraying or excessive wear", redFlag: "Discontinue use if damaged", interval: "1M" },
          { task: "Call vendor for annual mobility base inspection and return to app to refresh reminders", redFlag: "", interval: "1Y" }
        ]
      },
      "Tilt in Space Manual Wheelchair": { 
        label: "Tilt in Space Manual Wheelchair",
        tasks: [
          { task: "Ensure wheelchair rolls straight without excessive drag or pull", redFlag: "Contact vendor if issues persist", interval: "1W" },
          { task: "Ensure hand grips are not loose", redFlag: "Contact vendor if loose", interval: "1W" },
          { task: "Ensure wheel/fork assembly has proper tension when caster is spun", redFlag: "Contact vendor if wobbly", interval: "1W" },
          { task: "Loosen/tighten caster locknut if wheel wobbles or binds", redFlag: "Contact vendor if issue persists", interval: "1W" },
          { task: "Ensure all caster/wheel/fork/headtube fasteners are secure", redFlag: "Contact vendor if loose", interval: "1W" },
          { task: "Ensure casters are free of debris", redFlag: "Contact vendor if clogged", interval: "1W" },
          { task: "Check pneumatic tires for proper inflation", redFlag: "Contact vendor if pressure drops", interval: "1W" },
          { task: "Ensure no excessive side movement or binding when drive wheels are lifted and spun", redFlag: "Contact vendor if wobbly", interval: "1M" },
          { task: "Ensure sealed bearings and axle nut tension are correct", redFlag: "Contact vendor if wobbly", interval: "1M" },
          { task: "Ensure wheel locks do not interfere with tires when rolling", redFlag: "Contact vendor if interference", interval: "1M" },
          { task: "Ensure wheel lock pivot points are free of wear and looseness", redFlag: "Contact vendor if worn", interval: "1M" },
          { task: "Ensure wheel locks are easy to engage", redFlag: "Contact vendor if difficult", interval: "1M" },
          { task: "Inspect axles to ensure they are free from dirt, lint, etc.", redFlag: "Contact vendor if dirty", interval: "1M" },
          { task: "Inspect tilt slides and roller bearings to ensure they are free from dirt, lint, etc.", redFlag: "Contact vendor if dirty", interval: "1M" },
          { task: "Inspect seat positioning strap for wear, ensure buckle latches, and verify hardware is secure", redFlag: "Replace if necessary", interval: "1M" },
          { task: "Inspect clothing guards for bent or protruding metal", redFlag: "Contact vendor if damaged", interval: "6M" },
          { task: "Ensure arms are secure but easy to release", redFlag: "Contact vendor if not secure", interval: "6M" },
          { task: "Ensure adjustable height arms operate and lock securely", redFlag: "Contact vendor if fails", interval: "6M" },
          { task: "Ensure armrest upholstery has no rips", redFlag: "Contact vendor if damaged", interval: "6M" },
          { task: "Ensure armrest pad sits flush against arm tube", redFlag: "Contact vendor if misaligned", interval: "6M" },
          { task: "Ensure seat, back, and/or arm upholstery have no rips", redFlag: "Contact vendor if damaged", interval: "6M" },
          { task: "Ensure trigger release lever cables and handles return when released", redFlag: "Contact vendor if fails", interval: "6M" },
          { task: "Inspect handrims for rough edges or peeling", redFlag: "Contact vendor if damaged", interval: "6M" },
          { task: "Check that all labels are present and legible", redFlag: "Contact vendor if missing", interval: "6M" },
          { task: "Call vendor for annual mobility base inspection and return to app to refresh reminders", redFlag: "", interval: "1Y" }
        ]
      },
      "Hand-Rim Activated Power Assist": { 
        label: "Hand-Rim Activated Power Assist",
        tasks: [
          { task: "Clean power assist unit, including hand-rims and motors, with damp cloth", redFlag: "Contact vendor if cleaning reveals damage", interval: "1W" },
          { task: "Check all electrical connections and cables for wear or damage", redFlag: "Contact vendor if damaged", interval: "1W" },
          { task: "Inspect hand-rims for smooth operation and check for rough edges", redFlag: "Contact vendor if unsafe", interval: "1W" },
          { task: "Inspect tires for proper inflation if pneumatic", redFlag: "Contact vendor if pressure drops", interval: "1W" },
          { task: "Lubricate moving parts with recommended lubricant", redFlag: "Contact vendor if noisy", interval: "1M" },
          { task: "Inspect motor and wheel assembly for unusual noises or vibrations", redFlag: "Contact vendor if detected", interval: "1M" },
          { task: "Check battery terminals for corrosion", redFlag: "Contact vendor if corroded", interval: "1M" },
          { task: "Verify firmware version and update if necessary", redFlag: "Contact vendor if issues", interval: "1M" },
          { task: "Call vendor for annual technician maintenance inspection", redFlag: "", interval: "1Y" }
        ]
      },
      "Detachable Power Assist": { 
        label: "Detachable Power Assist",
        tasks: [
          { task: "Clean power assist unit with damp cloth", redFlag: "Contact vendor if cleaning reveals damage", interval: "1W" },
          { task: "Check all electrical connections and cables for wear or damage", redFlag: "Contact vendor if damaged", interval: "1W" },
          { task: "Test brakes by engaging and disengaging", redFlag: "Contact vendor if fails", interval: "1W" },
          { task: "Inspect tires for proper inflation if pneumatic", redFlag: "Contact vendor if pressure drops", interval: "1W" },
          { task: "Lubricate moving parts with recommended lubricant", redFlag: "Contact vendor if noisy", interval: "1M" },
          { task: "Inspect motor and wheel assembly for unusual noises or vibrations", redFlag: "Contact vendor if detected", interval: "1M" },
          { task: "Check battery terminals for corrosion", redFlag: "Contact vendor if corroded", interval: "1M" },
          { task: "Verify firmware version and update if necessary", redFlag: "Contact vendor if issues", interval: "1M" },
          { task: "Call vendor for annual technician maintenance inspection", redFlag: "", interval: "1Y" }
        ]
      },
      "Air Backrest Cushion": { 
        label: "Air Backrest Cushion",
        tasks: [
          { task: "Remove outer cover and machine wash", redFlag: "Contact vendor if cleaning fails", interval: "1W" },
          { task: "Clean air cushion with damp cloth", redFlag: "Contact vendor if degraded", interval: "1M" },
          { task: "Ensure all fill valves are closed securely", redFlag: "Contact vendor if leaks", interval: "1M" },
          { task: "Call vendor for annual technician maintenance inspection", redFlag: "", interval: "1Y" }
        ]
      },
      "Foam Backrest Cushion": { 
        label: "Foam Backrest Cushion",
        tasks: [
          { task: "Remove outer cover and machine wash", redFlag: "Contact vendor if cleaning fails", interval: "1W" },
          { task: "Clean foam base with damp cloth", redFlag: "Contact vendor if degraded", interval: "1M" },
          { task: "Call vendor for annual technician maintenance inspection", redFlag: "", interval: "1Y" }
        ]
      },
      "Gel Backrest Cushion": { 
        label: "Gel Backrest Cushion",
        tasks: [
          { task: "Remove outer cover and machine wash", redFlag: "Contact vendor if cleaning fails", interval: "1W" },
          { task: "Clean fluid insert with warm water and soap", redFlag: "Contact vendor if degraded", interval: "1M" },
          { task: "Clean foam base with damp cloth", redFlag: "Contact vendor if degraded", interval: "1M" },
          { task: "Call vendor for annual technician maintenance inspection", redFlag: "", interval: "1Y" }
        ]
      },
      "Air Seat Cushion": { 
        label: "Air Seat Cushion",
        tasks: [
          { task: "Remove outer cover and machine wash", redFlag: "Contact vendor if cleaning fails", interval: "1W" },
          { task: "Clean air cushion with damp cloth", redFlag: "Contact vendor if degraded", interval: "1M" },
          { task: "Ensure all fill valves are closed securely", redFlag: "Contact vendor if leaks", interval: "1M" },
          { task: "Call vendor for annual technician maintenance inspection", redFlag: "", interval: "1Y" }
        ]
      },
      "Foam Seat Cushion": { 
        label: "Foam Seat Cushion",
        tasks: [
          { task: "Remove outer cover and machine wash", redFlag: "Contact vendor if cleaning fails", interval: "1W" },
          { task: "Clean foam base with damp cloth", redFlag: "Contact vendor if degraded", interval: "1M" },
          { task: "Call vendor for annual technician maintenance inspection", redFlag: "", interval: "1Y" }
        ]
      },
      "Gel Seat Cushion": { 
        label: "Gel Seat Cushion",
        tasks: [
          { task: "Remove outer cover and machine wash", redFlag: "Contact vendor if cleaning fails", interval: "1W" },
          { task: "Clean fluid insert with warm water and soap", redFlag: "Contact vendor if degraded", interval: "1M" },
          { task: "Clean foam base with damp cloth", redFlag: "Contact vendor if degraded", interval: "1M" },
          { task: "Call vendor for annual technician maintenance inspection", redFlag: "", interval: "1Y" }
        ]
      }
    };

    let selectedComponents = [];
    let profileId = localStorage.getItem("profileId") || generateProfileId();
    let contacts = JSON.parse(localStorage.getItem(`contacts_${profileId}`) || "{}");
    let userCount = parseInt(localStorage.getItem("userCount") || "0");
    let reminderCount = parseInt(localStorage.getItem("reminderCount") || "0");
    let disableCount = parseInt(localStorage.getItem("disableCount") || "0");
    let mobilityBaseCount = JSON.parse(localStorage.getItem("mobilityBaseCount") || '{"n/a": 0, "Rigid Ultra-Light Manual Wheelchair": 0, "Folding Ultra-Light Manual Wheelchair": 0, "Power Wheelchair with Power Seating Functions": 0, "Power Wheelchair without Power Seating Functions": 0, "Tilt in Space Manual Wheelchair": 0, "Hand-Rim Activated Power Assist": 0, "Detachable Power Assist": 0}');
    let backrestCount = JSON.parse(localStorage.getItem("backrestCount") || '{"n/a": 0, "Air Backrest Cushion": 0, "Foam Backrest Cushion": 0, "Gel Backrest Cushion": 0}');
    let seatCount = JSON.parse(localStorage.getItem("seat-count") || '{"n/a": 0, "Air Seat Cushion": 0, "Foam Seat Cushion": 0, "Gel Seat Cushion": 0}');
    let startDate = localStorage.getItem(`startDate_${profileId}`) || new Date().toLocaleDateString();
    let currentStep = localStorage.getItem(`currentStep_${profileId}`) || "selection";
    let remindersEnabled = localStorage.getItem(`remindersEnabled_${profileId}`) !== "false";

    function generateProfileId() {
      try {
        return fetch("https://api.ipify.org?format=json")
          .then(res => res.json())
          .then(data => data.ip)
          .catch(() => "default-" + Date.now());
      } catch (error) {
        return "default-" + Date.now();
      }
    }

    function updateDisplay() {
      document.getElementById("selection-card").classList.toggle("hidden", currentStep !== "selection");
      document.getElementById("contact-card").classList.toggle("hidden", currentStep !== "contact");
      document.getElementById("reminders-card").classList.toggle("hidden", currentStep !== "reminders");
      document.getElementById("profile-card").classList.toggle("hidden", currentStep !== "profile");
      document.getElementById("admin-data").classList.toggle("hidden", currentStep !== "admin");
      updateSinceDate();
      updateProfileList();
      updateEquipmentList();
      document.getElementById("calendar-instructions").style.display = remindersEnabled ? "block" : "none"; // Show instructions if reminders enabled
    }

    function updateSinceDate() {
      const sinceDateElements = document.querySelectorAll("#since-date");
      sinceDateElements.forEach(el => el.textContent = `Maintaining my equipment since ${startDate}`);
    }

    function updateProfileList() {
      const profileList = document.getElementById("profile-list");
      profileList.innerHTML = selectedComponents.map(comp => `<li>${MAINTENANCE_SCHEDULES[comp]?.label || (Array.isArray(MAINTENANCE_SCHEDULES[comp]?.tasks) ? MAINTENANCE_SCHEDULES[comp].tasks[0].label : comp)}</li>`).join("");
    }

    function updateEquipmentList() {
      const equipmentList = document.getElementById("equipment-list");
      equipmentList.innerHTML = selectedComponents.map(comp => `<li>${MAINTENANCE_SCHEDULES[comp]?.label || (Array.isArray(MAINTENANCE_SCHEDULES[comp]?.tasks) ? MAINTENANCE_SCHEDULES[comp].tasks[0].label : comp)}</li>`).join("");
    }

    function saveData() {
      if (profileId) {
        localStorage.setItem(`profile_${profileId}`, JSON.stringify(selectedComponents));
        localStorage.setItem(`contacts_${profileId}`, JSON.stringify(contacts));
        localStorage.setItem(`currentStep_${profileId}`, currentStep);
        localStorage.setItem(`remindersEnabled_${profileId}`, remindersEnabled);
        // Update category counts
        Object.keys(mobilityBaseCount).forEach(key => mobilityBaseCount[key] = 0);
        Object.keys(backrestCount).forEach(key => backrestCount[key] = 0);
        Object.keys(seatCount).forEach(key => seatCount[key] = 0);
        selectedComponents.forEach(comp => {
          if (["Rigid Ultra-Light Manual Wheelchair", "Folding Ultra-Light Manual Wheelchair", "Power Wheelchair with Power Seating Functions", "Power Wheelchair without Power Seating Functions", "Tilt in Space Manual Wheelchair", "Hand-Rim Activated Power Assist", "Detachable Power Assist"].includes(comp)) {
            mobilityBaseCount[comp] = (mobilityBaseCount[comp] || 0) + 1;
          } else if (comp.includes("Backrest")) {
            backrestCount[comp] = (backrestCount[comp] || 0) + 1;
          } else if (comp.includes("Seat")) {
            seatCount[comp] = (seatCount[comp] || 0) + 1;
          }
        });
        localStorage.setItem("mobilityBaseCount", JSON.stringify(mobilityBaseCount));
        localStorage.setItem("backrestCount", JSON.stringify(backrestCount));
        localStorage.setItem("seat-count", JSON.stringify(seatCount));
        localStorage.setItem("userCount", userCount);
        localStorage.setItem("reminder-count", reminderCount);
        localStorage.setItem("disable-count", disableCount);
      }
    }

    function goHome() {
      currentStep = "profile";
      updateDisplay();
      saveData();
    }

    function goNext() {
      if (currentStep === "selection") {
        const primaryEquipment = document.getElementById("primary-equipment").value || null;
        if (primaryEquipment) selectedComponents = [primaryEquipment];
        const detachablePowerAssist = document.getElementById("detachable-power-assist").checked ? "Detachable Power Assist" : null;
        const handRimPowerAssist = document.getElementById("hand-rim-power-assist").checked ? "Hand-Rim Activated Power Assist" : null;
        if (detachablePowerAssist) selectedComponents.push(detachablePowerAssist);
        if (handRimPowerAssist) selectedComponents.push(handRimPowerAssist);
        ["air-seat", "foam-seat", "gel-seat", "air-backrest", "foam-backrest", "gel-backrest"].forEach(id => {
          if (document.getElementById(id).checked) selectedComponents.push(document.getElementById(id).value);
        });
        currentStep = "contact";
      } else if (currentStep === "contact") {
        contacts.vendor = {
          company: document.getElementById("vendor-company").value || "",
          rep: document.getElementById("vendor-rep").value || "",
          phone: document.getElementById("vendor-phone").value || "",
          email: document.getElementById("vendor-email").value || ""
        };
        contacts.therapist = {
          hospital: document.getElementById("therapist-hospital").value || "",
          name: document.getElementById("therapist-name").value || "",
          phone: document.getElementById("therapist-phone").value || "",
          email: document.getElementById("therapist-email").value || ""
        };
        currentStep = "reminders";
      }
      updateDisplay();
      saveData();
    }

    function submitReminders() {
      const equipmentList = document.getElementById("equipment-list");
      equipmentList.innerHTML = selectedComponents.map(comp => `<li>${MAINTENANCE_SCHEDULES[comp]?.label || (Array.isArray(MAINTENANCE_SCHEDULES[comp]?.tasks) ? MAINTENANCE_SCHEDULES[comp].tasks[0].label : comp)}</li>`).join("");
      currentStep = "profile"; // Redirect to profile on Finish
      updateDisplay();
      saveData();
    }

    function generateICS() {
      const now = new Date(); // Use local time
      now.setHours(9, 0, 0, 0); // Set to 9:00 AM local time
      const endDate = new Date(now.getFullYear(), now.getMonth() + 12, now.getDate()); // 1 year from now
      const dtstamp = now.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z'; // Keep DTSTAMP in UTC for compatibility
      const events = [];
      const maxEvents = 100; // Safeguard to prevent browser overload
      let eventCount = 0;

      // Group tasks by interval and component
      const tasksByInterval = {};
      selectedComponents.forEach(comp => {
        const schedule = MAINTENANCE_SCHEDULES[comp];
        if (Array.isArray(schedule.tasks)) {
          schedule.tasks.forEach(task => {
            if (["1W", "1M", "3M", "6M", "1Y"].includes(task.interval)) {
              if (!tasksByInterval[task.interval]) tasksByInterval[task.interval] = {};
              if (!tasksByInterval[task.interval][comp]) tasksByInterval[task.interval][comp] = [];
              tasksByInterval[task.interval][comp].push({ task: task.task, redFlag: task.redFlag });
            }
          });
        }
      });

      // Generate events for each interval
      Object.keys(tasksByInterval).forEach(interval => {
        let intervalDays = 0;
        switch (interval) {
          case "1W": intervalDays = 7; break;
          case "1M": intervalDays = 30; break;
          case "3M": intervalDays = 90; break;
          case "6M": intervalDays = 180; break;
          case "1Y": intervalDays = 365; break;
        }
        let currentDate = new Date(now);
        const maxIterations = Math.ceil(365 / intervalDays);
        let iteration = 0;

        while (currentDate <= endDate && iteration < maxIterations && eventCount < maxEvents) {
          Object.keys(tasksByInterval[interval]).forEach(comp => {
            const tasks = tasksByInterval[interval][comp];
            if (tasks.length > 0 && eventCount < maxEvents) {
              console.log(`Generating event for ${comp} at ${currentDate.toISOString()} for interval ${interval}`);
              const uid = `${profileId}-${currentDate.getTime()}-${Math.random().toString(36).substr(2, 9)}`;
              const schedule = MAINTENANCE_SCHEDULES[comp];
              const taskList = tasks.map(t => ` - ${t.task} (${t.redFlag ? t.redFlag : "No issues noted"})`).join("\\n");
              const vendorInfo = contacts.vendor.phone ? `Vendor Contact: ${contacts.vendor.company}, ${contacts.vendor.rep}, ${contacts.vendor.phone}, ${contacts.vendor.email}` : "";
              const therapistInfo = contacts.therapist.phone ? `Therapist Contact: ${contacts.therapist.hospital}, ${contacts.therapist.name}, ${contacts.therapist.phone}, ${contacts.therapist.email}` : "";
              const description = `Please complete the following for ${schedule.label}:\\n${taskList}\\n${vendorInfo}\\n${therapistInfo}`;
              const foldedDescription = `DESCRIPTION:${description.replace(/(.{1,70})(?:\s|$)/g, '$1\r\n ').trim()}`;
              const summary = `Reminder - Maintenance for ${schedule.label} (${interval === "1W" ? "Weekly" : interval === "1M" ? "Monthly" : interval === "3M" ? "Every 3 Months" : interval === "6M" ? "Every 6 Months" : "Yearly"})`;

              events.push(`BEGIN:VEVENT\r\nDTSTAMP:${dtstamp}\r\nUID:${uid}\r\nDTSTART:${currentDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z\r\nDURATION:P1D\r\nSUMMARY:${summary}\r\n${foldedDescription}\r\nBEGIN:VALARM\r\nTRIGGER:-PT0H\r\nACTION:DISPLAY\r\nDESCRIPTION:${summary}\r\nEND:VALARM\r\nEND:VEVENT`);
              eventCount++;
            }
          });
          currentDate.setDate(currentDate.getDate() + intervalDays);
          iteration++;
        }
      });

      if (eventCount >= maxEvents) {
        console.warn(`Event limit (${maxEvents}) reached, some reminders may be omitted.`);
      }

      if (events.length > 0) {
        const icsContent = `BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Wheelchair Maintenance Reminder//EN\r\n${events.join('\r\n')}\r\nEND:VCALENDAR`;

        try {
          const blob = new Blob([icsContent], { type: 'text/calendar' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `wheelchair_maintenance_${profileId}.ics`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          console.log(`Generated ${eventCount} events successfully.`);
        } catch (e) {
          console.error("Blob error:", e);
          alert("Failed to generate reminder schedule. Please try again or contact bperkins@metrohealth.org for support.");
        }
      } else {
        alert("No equipment selected to generate a reminder schedule.");
      }
    }

    function turnOffReminders() {
      // This function is now unused but kept for reference
      remindersEnabled = false;
      localStorage.setItem(`remindersEnabled_${profileId}`, "false");
      disableCount++;
      localStorage.setItem("disable-count", disableCount);
      document.getElementById("disable-count").textContent = disableCount;
      document.getElementById("calendar-instructions").style.display = "none";
      alert("Reminders have been turned off.");
    }

    function turnOnReminders() {
      if (selectedComponents.length > 0) {
        if (confirm("Are you sure you want to turn on reminders? A custom calendar file with 1 year of schedules will be generated.")) {
          remindersEnabled = true;
          localStorage.setItem(`remindersEnabled_${profileId}`, "true");
          generateICS(); // Generate and download ICS file
          document.getElementById("calendar-instructions").style.display = "block"; // Show instructions
          alert("Reminders turned on; download the calendar file and import it into your calendar app for the next 1 year.");
        }
      } else {
        alert("Please select at least one piece of equipment to enable reminders.");
      }
    }

    function resetData() {
      if (confirm("Are you sure you want to erase all data and reset the app?")) {
        localStorage.clear();
        location.reload();
      }
    }

    function editContacts() {
      currentStep = "contact";
      updateDisplay();
      const savedContacts = JSON.parse(localStorage.getItem(`contacts_${profileId}`) || "{}");
      if (savedContacts.vendor.company) {
        document.getElementById("vendor-company").value = savedContacts.vendor.company;
        document.getElementById("vendor-rep").value = savedContacts.vendor.rep;
        document.getElementById("vendor-phone").value = savedContacts.vendor.phone;
        document.getElementById("vendor-email").value = savedContacts.vendor.email || "";
      }
      if (savedContacts.therapist.name) {
        document.getElementById("therapist-hospital").value = savedContacts.therapist.hospital;
        document.getElementById("therapist-name").value = savedContacts.therapist.name;
        document.getElementById("therapist-phone").value = savedContacts.therapist.phone;
        document.getElementById("therapist-email").value = savedContacts.therapist.email || "";
      }
      saveData();
    }

    function editProfile() {
      currentStep = "selection";
      updateDisplay();
      selectedComponents = JSON.parse(localStorage.getItem(`profile_${profileId}`) || "[]");
      if (selectedComponents.length > 0) {
        document.getElementById("primary-equipment").value = selectedComponents.find(comp => Object.keys(MAINTENANCE_SCHEDULES).includes(comp)) || "";
        ["detachable-power-assist", "hand-rim-power-assist", "air-seat", "foam-seat", "gel-seat", "air-backrest", "foam-backrest", "gel-backrest"].forEach(id => {
          document.getElementById(id).checked = selectedComponents.includes(MAINTENANCE_SCHEDULES[id.replace("-", " ")]?.label);
        });
      }
      saveData();
    }

    function adminLogin() {
      const code = prompt("Enter admin code:");
      if (code === "6009") {
        currentStep = "admin";
        updateDisplay();
        updateAdminStats();
      } else {
        alert("Incorrect code.");
      }
    }

    function updateAdminStats() {
      document.getElementById("mobility-base-count").textContent = Object.entries(mobilityBaseCount).map(([key, value]) => `${key}: ${value}`).join(", ");
      document.getElementById("backrest-count").textContent = Object.entries(backrestCount).map(([key, value]) => `${key}: ${value}`).join(", ");
      document.getElementById("seat-count").textContent = Object.entries(seatCount).map(([key, value]) => `${key}: ${value}`).join(", ");
      document.getElementById("user-count").textContent = userCount;
      document.getElementById("reminder-count").textContent = reminderCount;
      document.getElementById("disable-count").textContent = disableCount;
    }

    // Initialize on load
    document.addEventListener("DOMContentLoaded", () => {
      localStorage.setItem("profileId", profileId);
      updateDisplay();
      saveData();
      updateAdminStats();

      document.querySelectorAll("#home-button").forEach(btn => btn.addEventListener("click", goHome));
      document.getElementById("next-to-contact").addEventListener("click", goNext);
      document.getElementById("submit-contact").addEventListener("click", goNext);
      document.getElementById("submit-reminders").addEventListener("click", submitReminders);
      document.getElementById("turn-on-reminders-profile").addEventListener("click", turnOnReminders);
      document.getElementById("reset-data-profile").addEventListener("click", resetData);
      document.getElementById("download-ics").addEventListener("click", generateICS);
    });
  </script>
</body>
</html>