<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wheelchair Maintenance Reminder</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="https://favicon.io/favicon.ico">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Wheelchair Reminder">
</head>
<body>
  <button class="admin-login" onclick="adminLogin()">Admin Login</button>
  <div class="container">
    <h1>Wheelchair Maintenance Reminder</h1>
    <div id="selection-card" class="card">
      <h2>Select Your Equipment</h2>
      <div class="selection-container">
        <table>
          <tr><th colspan="2" class="label">Primary Equipment (Optional)</th></tr>
          <tr><td colspan="2"><select id="primary-equipment" class="select"><option value="">Select one</option><option value="Rigid Ultra-Light Manual Wheelchair">Rigid Ultra-Light Manual Wheelchair</option><option value="Folding Ultra-Light Manual Wheelchair">Folding Ultra-Light Manual Wheelchair</option><option value="Power Wheelchair with Power Seating Functions">Power Wheelchair with Power Seating Functions</option><option value="Power Wheelchair without Power Seating Functions">Power Wheelchair without Power Seating Functions</option></select></td></tr>
          <tr><th colspan="2" class="label">Optional Power Assist (Select one or both)</th></tr>
          <tr><td><label><input type="checkbox" id="detachable-power-assist" value="Detachable Power Assist"> Detachable Power Assist</label></td><td><label><input type="checkbox" id="hand-rim-power-assist" value="Hand-Rim Activated Power Assist"> Hand-Rim Activated Power Assist</label></td></tr>
          <tr><th colspan="2" class="label">Seat Cushions (One or more)</th></tr>
          <tr><td><label><input type="checkbox" id="air-seat" value="Air Seat Cushion"> Air Seat Cushion</label></td><td><label><input type="checkbox" id="foam-seat" value="Foam Seat Cushion"> Foam Seat Cushion</label></td></tr>
          <tr><td><label><input type="checkbox" id="gel-seat" value="Gel Seat Cushion"> Gel Seat Cushion</label></td><td></td></tr>
          <tr><th colspan="2" class="label">Backrest Cushions (One or more)</th></tr>
          <tr><td><label><input type="checkbox" id="air-backrest" value="Air Backrest Cushion"> Air Backrest Cushion</label></td><td><label><input type="checkbox" id="foam-backrest" value="Foam Backrest Cushion"> Foam Backrest Cushion</label></td></tr>
          <tr><td><label><input type="checkbox" id="gel-backrest" value="Gel Backrest Cushion"> Gel Backrest Cushion</label></td><td></td></tr>
        </table>
      </div>
      <div class="nav-buttons">
        <button id="home-button" class="button">Home</button>
        <button id="next-to-contact" class="button">Next: Enter Contact Info</button>
      </div>
      <div class="since-date" id="since-date"></div>
    </div>
    <div id="contact-card" class="card hidden">
      <h2>Contact Information</h2>
      <form id="contact-form">
        <div class="label">Wheelchair Vendor</div>
        <input type="text" id="vendor-company" placeholder="Company Name" required>
        <input type="text" id="vendor-rep" placeholder="Representative Name" required>
        <input type="tel" id="vendor-phone" placeholder="Phone Number" required>
        <input type="email" id="vendor-email" placeholder="Email" required>
        <div class="label">Clinical Therapist</div>
        <input type="text" id="therapist-hospital" placeholder="Hospital/Clinic Name" required>
        <input type="text" id="therapist-name" placeholder="Therapist Name" required>
        <input type="tel" id="therapist-phone" placeholder="Phone Number" required>
        <input type="email" id="therapist-email" placeholder="Email" required>
      </form>
      <div class="nav-buttons">
        <button id="home-button" class="button">Home</button>
        <button id="submit-contact" class="button">Submit</button>
      </div>
      <div class="since-date" id="since-date"></div>
    </div>
    <div id="reminders-card" class="card hidden">
      <h2>My Equipment & Reminders</h2>
      <ul id="equipment-list"></ul>
      <div class="nav-buttons">
        <button id="home-button" class="button">Home</button>
        <button id="submit-reminders" class="button">Finish</button>
      </div>
      <div class="since-date" id="since-date"></div>
    </div>
    <div id="profile-card" class="card hidden">
      <h2>My Mobility Equipment</h2>
      <ul id="profile-list"></ul>
      <div class="profile-link" onclick="editContacts()">Edit Contact Information</div>
      <div class="profile-link" onclick="editProfile()">Edit My Equipment</div>
      <div class="nav-buttons">
        <!-- Removed "Home" button from profile -->
      </div>
      <button id="turn-off-reminders-profile" class="turn-off-button">Turn Off Reminders</button>
      <button id="turn-on-reminders-profile" class="turn-on-button">Turn On Reminders</button>
      <button id="reset-data-profile" class="reset-button">Reset/Erase Data</button>
      <div class="instructions" id="calendar-instructions">
        <h3>How to Add Your Reminder Schedule</h3>
        <p>1. Click the "Download Reminder Schedule" button below to download your custom calendar file.</p>
        <p>2. Open your calendar app (e.g., Google Calendar, Apple Calendar).</p>
        <p>3. Import the downloaded .ics file (look for "Import" or "Add Calendar" in the app settings).</p>
        <p>4. Set your preferred reminder time (e.g., 1 day before) in the calendar app.</p>
        <p><strong>Note:</strong> Reminders will appear based on the maintenance schedule for your selected equipment.</p>
        <button id="download-ics" class="button" style="margin-top: 1rem;">Download Reminder Schedule</button>
      </div>
      <div class="since-date" id="since-date"></div>
    </div>
    <div id="admin-data" class="card hidden">
      <h2>Admin Statistics</h2>
      <p>Mobility Base: <span id="mobility-base-count"></span></p>
      <p>Backrest Cushion: <span id="backrest-count"></span></p>
      <p>Seat Cushion: <span id="seat-count"></span></p>
      <p>Total Users: <span id="user-count">0</span></p>
      <p>Users with Reminders: <span id="reminder-count">0</span></p>
      <p>Users with Reminders Disabled: <span id="disable-count">0</span></p>
    </div>
    <div id="error" class="error" style="display: none;"></div>
  </div>
  <script>
    const MAINTENANCE_SCHEDULES = {
      "Rigid Ultra-Light Manual Wheelchair": { label: "Rigid Ultra-Light Manual Wheelchair", task: "Inspect camber plug clamps for tightness", redFlag: "Contact your vendor if clamps are loose", interval: "1M" },
      "Folding Ultra-Light Manual Wheelchair": { label: "Folding Ultra-Light Manual Wheelchair", task: "Inspect folding mechanism for smooth operation", redFlag: "Contact your vendor if mechanism sticks", interval: "1M" },
      "Hand-Rim Activated Power Assist": { label: "Hand-Rim Activated Power Assist", task: "Check battery capacity for full charge", redFlag: "Contact your therapist if battery fails", interval: "1M" },
      "Detachable Power Assist": { label: "Detachable Power Assist", task: "Inspect all components for wear or damage", redFlag: "Contact your therapist if components are damaged", interval: "1M" },
      "Power Wheelchair with Power Seating Functions": { label: "Power Wheelchair with Power Seating Functions", task: "Inspect battery level for adequate charge", redFlag: "Contact your vendor if battery fails", interval: "1M" },
      "Power Wheelchair without Power Seating Functions": { label: "Power Wheelchair without Power Seating Functions", task: "Inspect tire pressure for proper inflation", redFlag: "Contact your vendor if pressure drops", interval: "1M" },
      "Air Backrest Cushion": { label: "Air Backrest Cushion", task: "Check air inserts for leaks or deflation", redFlag: "Contact your vendor if air leaks are found", interval: "3M" },
      "Foam Backrest Cushion": { label: "Foam Backrest Cushion", task: "Inspect foam pad for signs of wear or flattening", redFlag: "Contact your vendor if foam is degraded", interval: "3M" },
      "Gel Backrest Cushion": { label: "Gel Backrest Cushion", task: "Inspect gel pad for cracks or leakage", redFlag: "Contact your vendor if gel is degraded", interval: "3M" },
      "Air Seat Cushion": { label: "Air Seat Cushion", task: "Check air cells for punctures or loss of air", redFlag: "Contact your vendor if punctures are found", interval: "3M" },
      "Foam Seat Cushion": { label: "Foam Seat Cushion", task: "Inspect foam for wear or compression", redFlag: "Contact your vendor if foam is degraded", interval: "3M" },
      "Gel Seat Cushion": { label: "Gel Seat Cushion", task: "Inspect fluid pad for leaks or damage", redFlag: "Contact your vendor if fluid leaks are found", interval: "3M" }
    };

    let selectedComponents = [];
    let profileId = localStorage.getItem("profileId") || generateProfileId();
    let contacts = JSON.parse(localStorage.getItem(`contacts_${profileId}`) || "{}");
    let userCount = parseInt(localStorage.getItem("userCount") || "0");
    let reminderCount = parseInt(localStorage.getItem("reminderCount") || "0");
    let disableCount = parseInt(localStorage.getItem("disableCount") || "0");
    let mobilityBaseCount = JSON.parse(localStorage.getItem("mobilityBaseCount") || '{"n/a": 0, "Rigid Ultra-Light Manual Wheelchair": 0, "Folding Ultra-Light Manual Wheelchair": 0, "Power Wheelchair with Power Seating Functions": 0, "Power Wheelchair without Power Seating Functions": 0, "Hand-Rim Activated Power Assist": 0, "Detachable Power Assist": 0}');
    let backrestCount = JSON.parse(localStorage.getItem("backrestCount") || '{"n/a": 0, "Air Backrest Cushion": 0, "Foam Backrest Cushion": 0, "Gel Backrest Cushion": 0}');
    let seatCount = JSON.parse(localStorage.getItem("seatCount") || '{"n/a": 0, "Air Seat Cushion": 0, "Foam Seat Cushion": 0, "Gel Seat Cushion": 0}');
    let startDate = localStorage.getItem(`startDate_${profileId}`) || new Date().toLocaleDateString();
    let currentStep = localStorage.getItem(`currentStep_${profileId}`) || "selection";
    let remindersEnabled = localStorage.getItem(`remindersEnabled_${profileId}`) !== "false";

    function generateProfileId() {
      try {
        return fetch("https://api.ipify.org?format=json")
          .then(res => res.json())
          .then(data => data.ip)
          .catch(() => "default-" + Date.now());
      } catch (error) {
        return "default-" + Date.now();
      }
    }

    function updateDisplay() {
      document.getElementById("selection-card").classList.toggle("hidden", currentStep !== "selection");
      document.getElementById("contact-card").classList.toggle("hidden", currentStep !== "contact");
      document.getElementById("reminders-card").classList.toggle("hidden", currentStep !== "reminders");
      document.getElementById("profile-card").classList.toggle("hidden", currentStep !== "profile");
      document.getElementById("admin-data").classList.toggle("hidden", currentStep !== "admin");
      updateSinceDate();
      updateProfileList();
      updateEquipmentList();
      document.getElementById("calendar-instructions").style.display = remindersEnabled ? "block" : "none"; // Show instructions if reminders enabled
    }

    function updateSinceDate() {
      const sinceDateElements = document.querySelectorAll("#since-date");
      sinceDateElements.forEach(el => el.textContent = `Maintaining my equipment since ${startDate}`);
    }

    function updateProfileList() {
      const profileList = document.getElementById("profile-list");
      profileList.innerHTML = selectedComponents.map(comp => `<li>${MAINTENANCE_SCHEDULES[comp]?.label || comp}</li>`).join("");
    }

    function updateEquipmentList() {
      const equipmentList = document.getElementById("equipment-list");
      equipmentList.innerHTML = selectedComponents.map(comp => `<li>${MAINTENANCE_SCHEDULES[comp]?.label || comp}</li>`).join("");
    }

    function saveData() {
      if (profileId) {
        localStorage.setItem(`profile_${profileId}`, JSON.stringify(selectedComponents));
        localStorage.setItem(`contacts_${profileId}`, JSON.stringify(contacts));
        localStorage.setItem(`currentStep_${profileId}`, currentStep);
        localStorage.setItem(`remindersEnabled_${profileId}`, remindersEnabled);
        // Update category counts
        Object.keys(mobilityBaseCount).forEach(key => mobilityBaseCount[key] = 0);
        Object.keys(backrestCount).forEach(key => backrestCount[key] = 0);
        Object.keys(seatCount).forEach(key => seatCount[key] = 0);
        selectedComponents.forEach(comp => {
          if (["Rigid Ultra-Light Manual Wheelchair", "Folding Ultra-Light Manual Wheelchair", "Power Wheelchair with Power Seating Functions", "Power Wheelchair without Power Seating Functions", "Hand-Rim Activated Power Assist", "Detachable Power Assist"].includes(comp)) {
            mobilityBaseCount[comp] = (mobilityBaseCount[comp] || 0) + 1;
          } else if (comp.includes("Backrest")) {
            backrestCount[comp] = (backrestCount[comp] || 0) + 1;
          } else if (comp.includes("Seat")) {
            seatCount[comp] = (seatCount[comp] || 0) + 1;
          }
        });
        localStorage.setItem("mobilityBaseCount", JSON.stringify(mobilityBaseCount));
        localStorage.setItem("backrestCount", JSON.stringify(backrestCount));
        localStorage.setItem("seat-count", JSON.stringify(seatCount));
        localStorage.setItem("userCount", userCount);
        localStorage.setItem("reminderCount", reminderCount);
        localStorage.setItem("disableCount", disableCount);
      }
    }

    function goHome() {
      currentStep = "profile";
      updateDisplay();
      saveData();
    }

    function goNext() {
      if (currentStep === "selection") {
        const primaryEquipment = document.getElementById("primary-equipment").value || null;
        if (primaryEquipment) selectedComponents = [primaryEquipment];
        const detachablePowerAssist = document.getElementById("detachable-power-assist").checked ? "Detachable Power Assist" : null;
        const handRimPowerAssist = document.getElementById("hand-rim-power-assist").checked ? "Hand-Rim Activated Power Assist" : null;
        if (detachablePowerAssist) selectedComponents.push(detachablePowerAssist);
        if (handRimPowerAssist) selectedComponents.push(handRimPowerAssist);
        ["air-seat", "foam-seat", "gel-seat", "air-backrest", "foam-backrest", "gel-backrest"].forEach(id => {
          if (document.getElementById(id).checked) selectedComponents.push(document.getElementById(id).value);
        });
        currentStep = "contact";
      } else if (currentStep === "contact") {
        contacts.vendor = {
          company: document.getElementById("vendor-company").value || "",
          rep: document.getElementById("vendor-rep").value || "",
          phone: document.getElementById("vendor-phone").value || "",
          email: document.getElementById("vendor-email").value || ""
        };
        contacts.therapist = {
          hospital: document.getElementById("therapist-hospital").value || "",
          name: document.getElementById("therapist-name").value || "",
          phone: document.getElementById("therapist-phone").value || "",
          email: document.getElementById("therapist-email").value || ""
        };
        currentStep = "reminders";
      }
      updateDisplay();
      saveData();
    }

    function submitReminders() {
      const equipmentList = document.getElementById("equipment-list");
      equipmentList.innerHTML = selectedComponents.map(comp => `<li>${MAINTENANCE_SCHEDULES[comp]?.label || comp}</li>`).join("");
      currentStep = "profile"; // Redirect to profile on Finish
      updateDisplay();
      saveData();
    }

    function generateICS() {
      const now = new Date();
      const events = selectedComponents.map(comp => {
        const schedule = MAINTENANCE_SCHEDULES[comp];
        const start = new Date(now);
        const interval = schedule.interval === "3M" ? 3 : 1; // Monthly (1M) or quarterly (3M)
        const vendorInfo = schedule.redFlag.includes("Contact vendor") && contacts.vendor.phone
          ? `Vendor: ${contacts.vendor.company}, ${contacts.vendor.rep}, ${contacts.vendor.phone}, ${contacts.vendor.email}`
          : "";
        return `BEGIN:VEVENT
DTSTART:${start.toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DURATION:P${interval}M
SUMMARY:Reminder - ${schedule.task} for ${schedule.label}
DESCRIPTION:Please ${schedule.task}.\n${schedule.redFlag}\n${vendorInfo}
RRULE:FREQ=MONTHLY;INTERVAL=${interval}
END:VEVENT`;
      }).join('\n');

      if (events) {
        const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Wheelchair Maintenance Reminder//EN
${events}
END:VCALENDAR`;

        const blob = new Blob([icsContent], { type: 'text/calendar' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `wheelchair_maintenance_${profileId}.ics`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      } else {
        alert("No equipment selected to generate a reminder schedule.");
      }
    }

    function turnOffReminders() {
      remindersEnabled = false;
      localStorage.setItem(`remindersEnabled_${profileId}`, "false");
      disableCount++;
      localStorage.setItem("disableCount", disableCount);
      document.getElementById("disable-count").textContent = disableCount;
      document.getElementById("calendar-instructions").style.display = "none"; // Hide instructions
      alert("Reminders have been turned off.");
    }

    function turnOnReminders() {
      if (selectedComponents.length > 0) {
        if (confirm("Are you sure you want to turn on reminders? A custom calendar file will be generated for your selected equipment.")) {
          remindersEnabled = true;
          localStorage.setItem(`remindersEnabled_${profileId}`, "true");
          generateICS(); // Generate and download ICS file
          document.getElementById("calendar-instructions").style.display = "block"; // Show instructions
          alert("Reminders turned on; download the calendar file and import it into your calendar app.");
        }
      } else {
        alert("Please select at least one piece of equipment to enable reminders.");
      }
    }

    function resetData() {
      if (confirm("Are you sure you want to erase all data and reset the app?")) {
        localStorage.clear();
        location.reload();
      }
    }

    function editContacts() {
      currentStep = "contact";
      updateDisplay();
      const savedContacts = JSON.parse(localStorage.getItem(`contacts_${profileId}`) || "{}");
      if (savedContacts.vendor.company) {
        document.getElementById("vendor-company").value = savedContacts.vendor.company;
        document.getElementById("vendor-rep").value = savedContacts.vendor.rep;
        document.getElementById("vendor-phone").value = savedContacts.vendor.phone;
        document.getElementById("vendor-email").value = savedContacts.vendor.email || "";
      }
      if (savedContacts.therapist.name) {
        document.getElementById("therapist-hospital").value = savedContacts.therapist.hospital;
        document.getElementById("therapist-name").value = savedContacts.therapist.name;
        document.getElementById("therapist-phone").value = savedContacts.therapist.phone;
        document.getElementById("therapist-email").value = savedContacts.therapist.email || "";
      }
      saveData();
    }

    function editProfile() {
      currentStep = "selection";
      updateDisplay();
      selectedComponents = JSON.parse(localStorage.getItem(`profile_${profileId}`) || "[]");
      if (selectedComponents.length > 0) {
        document.getElementById("primary-equipment").value = selectedComponents.find(comp => Object.keys(MAINTENANCE_SCHEDULES).includes(comp)) || "";
        ["detachable-power-assist", "hand-rim-power-assist", "air-seat", "foam-seat", "gel-seat", "air-backrest", "foam-backrest", "gel-backrest"].forEach(id => {
          document.getElementById(id).checked = selectedComponents.includes(MAINTENANCE_SCHEDULES[id.replace("-", " ")]?.label);
        });
      }
      saveData();
    }

    function adminLogin() {
      const code = prompt("Enter admin code:");
      if (code === "6009") {
        currentStep = "admin";
        updateDisplay();
        updateAdminStats();
      } else {
        alert("Incorrect code.");
      }
    }

    function updateAdminStats() {
      document.getElementById("mobility-base-count").textContent = Object.entries(mobilityBaseCount).map(([key, value]) => `${key}: ${value}`).join(", ");
      document.getElementById("backrest-count").textContent = Object.entries(backrestCount).map(([key, value]) => `${key}: ${value}`).join(", ");
      document.getElementById("seat-count").textContent = Object.entries(seatCount).map(([key, value]) => `${key}: ${value}`).join(", ");
      document.getElementById("user-count").textContent = userCount;
      document.getElementById("reminder-count").textContent = reminderCount;
      document.getElementById("disable-count").textContent = disableCount;
    }

    // Initialize on load
    document.addEventListener("DOMContentLoaded", () => {
      localStorage.setItem("profileId", profileId);
      updateDisplay();
      saveData();
      updateAdminStats();

      document.querySelectorAll("#home-button").forEach(btn => btn.addEventListener("click", goHome));
      document.getElementById("next-to-contact").addEventListener("click", goNext);
      document.getElementById("submit-contact").addEventListener("click", goNext);
      document.getElementById("submit-reminders").addEventListener("click", submitReminders);
      document.getElementById("turn-off-reminders-profile").addEventListener("click", turnOffReminders);
      document.getElementById("turn-on-reminders-profile").addEventListener("click", turnOnReminders);
      document.getElementById("reset-data-profile").addEventListener("click", resetData);
      document.getElementById("download-ics").addEventListener("click", generateICS);
    });
  </script>
</body>
</html>