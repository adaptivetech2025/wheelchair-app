<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wheelchair Maintenance Reminder</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="https://favicon.io/favicon.ico">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Wheelchair Reminder">
</head>
<body>
  <button class="admin-login" onclick="adminLogin()">Admin Login</button>
  <div class="container">
    <h1>Wheelchair Maintenance Reminder</h1>
    <div id="selection-card" class="card">
      <h2>Select Your Equipment</h2>
      <div class="selection-container">
        <table>
          <tr><th colspan="2" class="label">Primary Equipment (Optional)</th></tr>
          <tr><td colspan="2"><select id="primary-equipment" class="select"><option value="">Select one</option><option value="Rigid Ultra-Light Manual Wheelchair">Rigid Ultra-Light Manual Wheelchair</option><option value="Folding Ultra-Light Manual Wheelchair">Folding Ultra-Light Manual Wheelchair</option><option value="Power Wheelchair with Power Seating Functions">Power Wheelchair with Power Seating Functions</option><option value="Power Wheelchair without Power Seating Functions">Power Wheelchair without Power Seating Functions</option></select></td></tr>
          <tr><th colspan="2" class="label">Optional Power Assist (Select one or both)</th></tr>
          <tr><td><label><input type="checkbox" id="detachable-power-assist" value="Detachable Power Assist"> Detachable Power Assist</label></td><td><label><input type="checkbox" id="hand-rim-power-assist" value="Hand-Rim Activated Power Assist"> Hand-Rim Activated Power Assist</label></td></tr>
          <tr><th colspan="2" class="label">Seat Cushions (One or more)</th></tr>
          <tr><td><label><input type="checkbox" id="air-seat" value="Air Seat Cushion"> Air Seat Cushion</label></td><td><label><input type="checkbox" id="foam-seat" value="Foam Seat Cushion"> Foam Seat Cushion</label></td></tr>
          <tr><td><label><input type="checkbox" id="gel-seat" value="Gel Seat Cushion"> Gel Seat Cushion</label></td><td></td></tr>
          <tr><th colspan="2" class="label">Backrest Cushions (One or more)</th></tr>
          <tr><td><label><input type="checkbox" id="air-backrest" value="Air Backrest Cushion"> Air Backrest Cushion</label></td><td><label><input type="checkbox" id="foam-backrest" value="Foam Backrest Cushion"> Foam Backrest Cushion</label></td></tr>
          <tr><td><label><input type="checkbox" id="gel-backrest" value="Gel Backrest Cushion"> Gel Backrest Cushion</label></td><td></td></tr>
        </table>
      </div>
      <div class="nav-buttons">
        <button id="home-button" class="button">Home</button>
        <button id="next-to-contact" class="button">Next: Enter Contact Info</button>
      </div>
      <div class="since-date" id="since-date"></div>
    </div>
    <div id="contact-card" class="card hidden">
      <h2>Contact Information</h2>
      <form id="contact-form">
        <div class="label">Wheelchair Vendor</div>
        <input type="text" id="vendor-company" placeholder="Company Name" required>
        <input type="text" id="vendor-rep" placeholder="Representative Name" required>
        <input type="tel" id="vendor-phone" placeholder="Phone Number" required>
        <input type="email" id="vendor-email" placeholder="Email" required>
        <div class="label">Clinical Therapist</div>
        <input type="text" id="therapist-hospital" placeholder="Hospital/Clinic Name" required>
        <input type="text" id="therapist-name" placeholder="Therapist Name" required>
        <input type="tel" id="therapist-phone" placeholder="Phone Number" required>
        <input type="email" id="therapist-email" placeholder="Email" required>
      </form>
      <div class="nav-buttons">
        <button id="home-button" class="button">Home</button>
        <button id="submit-contact" class="button">Submit</button>
      </div>
      <div class="since-date" id="since-date"></div>
    </div>
    <div id="reminders-card" class="card hidden">
      <h2>My Equipment & Reminders</h2>
      <ul id="equipment-list"></ul>
      <div class="nav-buttons">
        <button id="home-button" class="button">Home</button>
        <button id="submit-reminders" class="button">Finish</button>
      </div>
      <div class="since-date" id="since-date"></div>
    </div>
    <div id="profile-card" class="card hidden">
      <h2>My Mobility Equipment</h2>
      <ul id="profile-list"></ul>
      <div class="profile-link" onclick="editContacts()">Edit Contact Information</div>
      <div class="profile-link" onclick="editProfile()">Edit My Equipment</div>
      <div class="nav-buttons">
        <!-- Removed "Home" button from profile -->
      </div>
      <button id="turn-off-reminders-profile" class="turn-off-button">Turn Off Reminders</button>
      <button id="turn-on-reminders-profile" class="turn-on-button">Turn On Reminders</button>
      <button id="reset-data-profile" class="reset-button">Reset/Erase Data</button>
      <div class="since-date" id="since-date"></div>
    </div>
    <div id="admin-data" class="card hidden">
      <h2>Admin Statistics</h2>
      <p>Mobility Base: <span id="mobility-base-count"></span></p>
      <p>Backrest Cushion: <span id="backrest-count"></span></p>
      <p>Seat Cushion: <span id="seat-count"></span></p>
      <p>Total Users: <span id="user-count">0</span></p>
      <p>Users with Reminders: <span id="reminder-count">0</span></p>
      <p>Users with Reminders Disabled: <span id="disable-count">0</span></p>
    </div>
    <div id="error" class="error" style="display: none;"></div>
  </div>
  <script>
    const MAINTENANCE_SCHEDULES = {
      "Rigid Ultra-Light Manual Wheelchair": { label: "Rigid Ultra-Light Manual Wheelchair", task: "Check camber plug clamps", redFlag: "Contact vendor if loose" },
      "Folding Ultra-Light Manual Wheelchair": { label: "Folding Ultra-Light Manual Wheelchair", task: "Check folding mechanism", redFlag: "Contact vendor if sticks" },
      "Hand-Rim Activated Power Assist": { label: "Hand-Rim Activated Power Assist", task: "Check battery capacity", redFlag: "Contact dealer if fails" },
      "Detachable Power Assist": { label: "Detachable Power Assist", task: "Inspect components", redFlag: "Contact dealer if damaged" },
      "Power Wheelchair with Power Seating Functions": { label: "Power Wheelchair with Power Seating Functions", task: "Check battery level", redFlag: "Contact vendor if fails" },
      "Power Wheelchair without Power Seating Functions": { label: "Power Wheelchair without Power Seating Functions", task: "Check tires", redFlag: "Contact vendor if pressure drops" },
      "Air Backrest Cushion": { label: "Air Backrest Cushion", task: "Check air inserts", redFlag: "Contact vendor if leaks" },
      "Foam Backrest Cushion": { label: "Foam Backrest Cushion", task: "Inspect foam pad", redFlag: "Contact vendor if degraded" },
      "Gel Backrest Cushion": { label: "Gel Backrest Cushion", task: "Inspect gel pad", redFlag: "Contact vendor if degraded" },
      "Air Seat Cushion": { label: "Air Seat Cushion", task: "Check air cells", redFlag: "Contact vendor if punctures" },
      "Foam Seat Cushion": { label: "Foam Seat Cushion", task: "Inspect foam", redFlag: "Contact vendor if degraded" },
      "Gel Seat Cushion": { label: "Gel Seat Cushion", task: "Inspect fluid pad", redFlag: "Contact vendor if leaks" }
    };

    let selectedComponents = [];
    let profileId = localStorage.getItem("profileId") || generateProfileId();
    let contacts = JSON.parse(localStorage.getItem(`contacts_${profileId}`) || "{}");
    let userCount = parseInt(localStorage.getItem("userCount") || "0");
    let reminderCount = parseInt(localStorage.getItem("reminderCount") || "0");
    let disableCount = parseInt(localStorage.getItem("disableCount") || "0");
    let mobilityBaseCount = JSON.parse(localStorage.getItem("mobilityBaseCount") || '{"n/a": 0, "Rigid Ultra-Light Manual Wheelchair": 0, "Folding Ultra-Light Manual Wheelchair": 0, "Power Wheelchair with Power Seating Functions": 0, "Power Wheelchair without Power Seating Functions": 0, "Hand-Rim Activated Power Assist": 0, "Detachable Power Assist": 0}');
    let backrestCount = JSON.parse(localStorage.getItem("backrestCount") || '{"n/a": 0, "Air Backrest Cushion": 0, "Foam Backrest Cushion": 0, "Gel Backrest Cushion": 0}');
    let seatCount = JSON.parse(localStorage.getItem("seatCount") || '{"n/a": 0, "Air Seat Cushion": 0, "Foam Seat Cushion": 0, "Gel Seat Cushion": 0}');
    let startDate = localStorage.getItem(`startDate_${profileId}`) || new Date().toLocaleDateString();
    let currentStep = localStorage.getItem(`currentStep_${profileId}`) || "selection";
    let remindersEnabled = localStorage.getItem(`remindersEnabled_${profileId}`) !== "false";
    let lastNotified = localStorage.getItem(`lastNotified_${profileId}`) || 0;

    function generateProfileId() {
      try {
        return fetch("https://api.ipify.org?format=json")
          .then(res => res.json())
          .then(data => data.ip)
          .catch(() => "default-" + Date.now());
      } catch (error) {
        return "default-" + Date.now();
      }
    }

    function updateDisplay() {
      document.getElementById("selection-card").classList.toggle("hidden", currentStep !== "selection");
      document.getElementById("contact-card").classList.toggle("hidden", currentStep !== "contact");
      document.getElementById("reminders-card").classList.toggle("hidden", currentStep !== "reminders");
      document.getElementById("profile-card").classList.toggle("hidden", currentStep !== "profile");
      document.getElementById("admin-data").classList.toggle("hidden", currentStep !== "admin");
      updateSinceDate();
      updateProfileList();
      updateEquipmentList();
    }

    function updateSinceDate() {
      const sinceDateElements = document.querySelectorAll("#since-date");
      sinceDateElements.forEach(el => el.textContent = `Maintaining my equipment since ${startDate}`);
    }

    function updateProfileList() {
      const profileList = document.getElementById("profile-list");
      profileList.innerHTML = selectedComponents.map(comp => `<li>${MAINTENANCE_SCHEDULES[comp]?.label || comp}</li>`).join("");
    }

    function updateEquipmentList() {
      const equipmentList = document.getElementById("equipment-list");
      equipmentList.innerHTML = selectedComponents.map(comp => `<li>${MAINTENANCE_SCHEDULES[comp]?.label || comp}</li>`).join("");
    }

    function saveData() {
      if (profileId) {
        localStorage.setItem(`profile_${profileId}`, JSON.stringify(selectedComponents));
        localStorage.setItem(`contacts_${profileId}`, JSON.stringify(contacts));
        localStorage.setItem(`currentStep_${profileId}`, currentStep);
        localStorage.setItem(`remindersEnabled_${profileId}`, remindersEnabled);
        localStorage.setItem(`lastNotified_${profileId}`, lastNotified);
        // Update category counts
        Object.keys(mobilityBaseCount).forEach(key => mobilityBaseCount[key] = 0);
        Object.keys(backrestCount).forEach(key => backrestCount[key] = 0);
        Object.keys(seatCount).forEach(key => seatCount[key] = 0);
        selectedComponents.forEach(comp => {
          if (["Rigid Ultra-Light Manual Wheelchair", "Folding Ultra-Light Manual Wheelchair", "Power Wheelchair with Power Seating Functions", "Power Wheelchair without Power Seating Functions", "Hand-Rim Activated Power Assist", "Detachable Power Assist"].includes(comp)) {
            mobilityBaseCount[comp] = (mobilityBaseCount[comp] || 0) + 1;
          } else if (comp.includes("Backrest")) {
            backrestCount[comp] = (backrestCount[comp] || 0) + 1;
          } else if (comp.includes("Seat")) {
            seatCount[comp] = (seatCount[comp] || 0) + 1;
          }
        });
        localStorage.setItem("mobilityBaseCount", JSON.stringify(mobilityBaseCount));
        localStorage.setItem("backrestCount", JSON.stringify(backrestCount));
        localStorage.setItem("seat-count", JSON.stringify(seatCount));
        localStorage.setItem("userCount", userCount);
        localStorage.setItem("reminderCount", reminderCount);
        localStorage.setItem("disableCount", disableCount);
      }
    }

    function goHome() {
      currentStep = "profile";
      updateDisplay();
      saveData();
    }

    function goNext() {
      if (currentStep === "selection") {
        const primaryEquipment = document.getElementById("primary-equipment").value || null;
        if (primaryEquipment) selectedComponents = [primaryEquipment];
        const detachablePowerAssist = document.getElementById("detachable-power-assist").checked ? "Detachable Power Assist" : null;
        const handRimPowerAssist = document.getElementById("hand-rim-power-assist").checked ? "Hand-Rim Activated Power Assist" : null;
        if (detachablePowerAssist) selectedComponents.push(detachablePowerAssist);
        if (handRimPowerAssist) selectedComponents.push(handRimPowerAssist);
        ["air-seat", "foam-seat", "gel-seat", "air-backrest", "foam-backrest", "gel-backrest"].forEach(id => {
          if (document.getElementById(id).checked) selectedComponents.push(document.getElementById(id).value);
        });
        currentStep = "contact";
      } else if (currentStep === "contact") {
        contacts.vendor = {
          company: document.getElementById("vendor-company").value || "",
          rep: document.getElementById("vendor-rep").value || "",
          phone: document.getElementById("vendor-phone").value || "",
          email: document.getElementById("vendor-email").value || ""
        };
        contacts.therapist = {
          hospital: document.getElementById("therapist-hospital").value || "",
          name: document.getElementById("therapist-name").value || "",
          phone: document.getElementById("therapist-phone").value || "",
          email: document.getElementById("therapist-email").value || ""
        };
        currentStep = "reminders";
      }
      updateDisplay();
      saveData();
    }

    function submitReminders() {
      const equipmentList = document.getElementById("equipment-list");
      equipmentList.innerHTML = selectedComponents.map(comp => `<li>${MAINTENANCE_SCHEDULES[comp]?.label || comp}</li>`).join("");
      currentStep = "profile"; // Redirect to profile on Finish
      updateDisplay();
      saveData();
      if (remindersEnabled && typeof Notification !== "undefined" && !isIOSChrome()) {
        if (Notification.permission !== "granted") {
          Notification.requestPermission().then(permission => {
            if (permission === "granted") {
              sendNotifications();
            }
          });
        } else {
          sendNotifications();
        }
      } else if (remindersEnabled && isIOSChrome()) {
        checkAndShowAlert();
      }
    }

    function sendNotifications() {
      if (remindersEnabled) {
        selectedComponents.forEach(component => {
          const schedule = MAINTENANCE_SCHEDULES[component];
          if (schedule && schedule.task) {
            let body = `${schedule.label} - ${schedule.redFlag}`;
            if (schedule.redFlag.includes("Contact vendor") && contacts.vendor.phone) {
              body += `; Vendor: ${contacts.vendor.company}, ${contacts.vendor.rep}, ${contacts.vendor.phone}, ${contacts.vendor.email}`;
            } else if (schedule.redFlag.includes("Contact dealer") && contacts.therapist.phone) {
              body += `; Therapist: ${contacts.therapist.name}, ${contacts.therapist.phone}, ${contacts.therapist.email} (${contacts.therapist.hospital})`;
            }
            new Notification(`Reminder: ${schedule.task}`, { body });
          }
        });
      }
    }

    function turnOffReminders() {
      remindersEnabled = false;
      localStorage.setItem(`remindersEnabled_${profileId}`, "false");
      disableCount++;
      localStorage.setItem("disableCount", disableCount);
      document.getElementById("disable-count").textContent = disableCount;
      alert("Reminders have been turned off.");
    }

    function turnOnReminders() {
      if (typeof Notification !== "undefined" && !isIOSChrome()) {
        if (confirm("Are you sure you want to turn on reminders? This will enable notifications.")) {
          remindersEnabled = true;
          localStorage.setItem(`remindersEnabled_${profileId}`, "true");
          if (Notification.permission !== "granted") {
            Notification.requestPermission().then(permission => {
              if (permission === "granted") {
                sendNotifications();
                alert("Reminders turned on and notifications sent.");
              } else {
                remindersEnabled = false;
                localStorage.setItem(`remindersEnabled_${profileId}`, "false");
                alert("Notifications not enabled. Please allow in settings.");
              }
            });
          } else {
            sendNotifications();
            alert("Reminders turned on and notifications sent.");
          }
        }
      } else if (isIOSChrome()) {
        if (confirm("Are you sure you want to turn on reminders? Notifications are not supported in Chrome on iOS; alerts will be used instead.")) {
          remindersEnabled = true;
          localStorage.setItem(`remindersEnabled_${profileId}`, "true");
          checkAndShowAlert();
          alert("Reminders turned on; alerts will appear periodically.");
        }
      } else {
        alert("This browser does not support notifications.");
      }
    }

    function isIOSChrome() {
      return /iP(ad|hone|od)/.test(navigator.userAgent) && /CriOS/.test(navigator.userAgent);
    }

    function checkAndShowAlert() {
      const now = Date.now();
      const twentyFourHours = 24 * 60 * 60 * 1000;
      if (remindersEnabled && now - lastNotified > twentyFourHours) {
        const sampleComponent = selectedComponents[0] || "your equipment";
        const sampleSchedule = MAINTENANCE_SCHEDULES[sampleComponent] || { task: "check your equipment", redFlag: "contact support" };
        alert(`Reminder: ${sampleSchedule.task}\n${sampleComponent} - ${sampleSchedule.redFlag}`);
        lastNotified = now;
        localStorage.setItem(`lastNotified_${profileId}`, lastNotified);
      }
    }

    function resetData() {
      if (confirm("Are you sure you want to erase all data and reset the app?")) {
        localStorage.clear();
        location.reload();
      }
    }

    function editContacts() {
      currentStep = "contact";
      updateDisplay();
      const savedContacts = JSON.parse(localStorage.getItem(`contacts_${profileId}`) || "{}");
      if (savedContacts.vendor.company) {
        document.getElementById("vendor-company").value = savedContacts.vendor.company;
        document.getElementById("vendor-rep").value = savedContacts.vendor.rep;
        document.getElementById("vendor-phone").value = savedContacts.vendor.phone;
        document.getElementById("vendor-email").value = savedContacts.vendor.email || "";
      }
      if (savedContacts.therapist.name) {
        document.getElementById("therapist-hospital").value = savedContacts.therapist.hospital;
        document.getElementById("therapist-name").value = savedContacts.therapist.name;
        document.getElementById("therapist-phone").value = savedContacts.therapist.phone;
        document.getElementById("therapist-email").value = savedContacts.therapist.email || "";
      }
      saveData();
    }

    function editProfile() {
      currentStep = "selection";
      updateDisplay();
      selectedComponents = JSON.parse(localStorage.getItem(`profile_${profileId}`) || "[]");
      if (selectedComponents.length > 0) {
        document.getElementById("primary-equipment").value = selectedComponents.find(comp => Object.keys(MAINTENANCE_SCHEDULES).includes(comp)) || "";
        ["detachable-power-assist", "hand-rim-power-assist", "air-seat", "foam-seat", "gel-seat", "air-backrest", "foam-backrest", "gel-backrest"].forEach(id => {
          document.getElementById(id).checked = selectedComponents.includes(MAINTENANCE_SCHEDULES[id.replace("-", " ")]?.label);
        });
      }
      saveData();
    }

    function adminLogin() {
      const code = prompt("Enter admin code:");
      if (code === "6009") {
        currentStep = "admin";
        updateDisplay();
        updateAdminStats();
      } else {
        alert("Incorrect code.");
      }
    }

    function updateAdminStats() {
      document.getElementById("mobility-base-count").textContent = Object.entries(mobilityBaseCount).map(([key, value]) => `${key}: ${value}`).join(", ");
      document.getElementById("backrest-count").textContent = Object.entries(backrestCount).map(([key, value]) => `${key}: ${value}`).join(", ");
      document.getElementById("seat-count").textContent = Object.entries(seatCount).map(([key, value]) => `${key}: ${value}`).join(", ");
      document.getElementById("user-count").textContent = userCount;
      document.getElementById("reminder-count").textContent = reminderCount;
      document.getElementById("disable-count").textContent = disableCount;
    }

    // Initialize on load and set up alert check
    document.addEventListener("DOMContentLoaded", () => {
      localStorage.setItem("profileId", profileId);
      updateDisplay();
      saveData();
      updateAdminStats();
      if (remindersEnabled && isIOSChrome()) {
        checkAndShowAlert(); // Initial check on load
        setInterval(checkAndShowAlert, 24 * 60 * 60 * 1000); // Check every 24 hours
      }

      document.querySelectorAll("#home-button").forEach(btn => btn.addEventListener("click", goHome));
      document.getElementById("next-to-contact").addEventListener("click", goNext);
      document.getElementById("submit-contact").addEventListener("click", goNext);
      document.getElementById("submit-reminders").addEventListener("click", submitReminders);
      document.getElementById("turn-off-reminders-profile").addEventListener("click", turnOffReminders);
      document.getElementById("turn-on-reminders-profile").addEventListener("click", turnOnReminders);
      document.getElementById("reset-data-profile").addEventListener("click", resetData);
    });
  </script>
</body>
</html>